
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="PostgreSQL schema and functions for Spatio-Temporal Asset Catalog (STAC).">
      
      
      
        <link rel="canonical" href="https://stac-utils.github.io/pgstac/pgstac/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../pypgstac/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>PgSTAC - pgstac</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pgstac-settings" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pgstac" class="md-header__button md-logo" aria-label="pgstac" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pgstac
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PgSTAC
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stac-utils/pgstac" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    stac-utils/pgstac
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pgstac" class="md-nav__button md-logo" aria-label="pgstac" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    pgstac
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stac-utils/pgstac" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    stac-utils/pgstac
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    PgSTAC
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    PgSTAC
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pgstac-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Settings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgstac-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-search-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Search Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-settings-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Settings Variables
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Settings Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-only-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Read Only Mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Runtime Configurations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Partitioning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-indexes-queryables" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Indexes / Queryables
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Indexes / Queryables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queryable-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Queryable Metadata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Indexing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maintenance Procedures
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Checks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Checks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-and-pgstac-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        System and pgSTAC Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unused-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unused Indexes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notification-triggers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notification Triggers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notification Triggers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-notification-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Notification Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Customization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pypgstac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pyPgSTAC
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Performance
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Performance
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../item_size_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    impacts of STAC item footprint size on dynamic tiling query performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development - Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Notes
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pgstac-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Settings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgstac-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-search-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Search Path
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-settings-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Settings Variables
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Settings Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-only-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Read Only Mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Runtime Configurations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Partitioning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pgstac-indexes-queryables" class="md-nav__link">
    <span class="md-ellipsis">
      
        PgSTAC Indexes / Queryables
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PgSTAC Indexes / Queryables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queryable-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Queryable Metadata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Indexing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maintenance Procedures
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Checks
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Checks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-and-pgstac-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        System and pgSTAC Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unused-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unused Indexes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notification-triggers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notification Triggers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notification Triggers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-notification-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Notification Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Customization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>PgSTAC</h1>

<p>PGDatabase Schema and Functions for Storing and Accessing STAC collections and items in PostgreSQL</p>
<p>STAC Client that uses PgSTAC available in <a href="https://github.com/stac-utils/stac-fastapi">STAC-FastAPI</a></p>
<p>PgSTAC requires <strong>Postgresql&gt;=13</strong>, <strong>PostGIS&gt;=3</strong> and <strong>btree_gist</strong>. Best performance will be had using PostGIS&gt;=3.1.</p>
<h3 id="pgstac-settings">PgSTAC Settings<a class="headerlink" href="#pgstac-settings" title="Permanent link">&para;</a></h3>
<p>PgSTAC installs everything into the pgstac schema in the database. This schema must be in the search_path in the postgresql session while using pgstac.</p>
<h4 id="pgstac-users">PgSTAC Users<a class="headerlink" href="#pgstac-users" title="Permanent link">&para;</a></h4>
<p>The <code>pgstac_admin</code> role is the owner of all the objects within pgstac and should be used when running things such as migrations.</p>
<p>The <code>pgstac_ingest</code> role has read/write privileges on all tables and should be used for data ingest or if using the transactions extension with stac-fastapi-pgstac.</p>
<p>The <code>pgstac_read</code> role has read only access to the items and collections, but will still be able to write to the logging tables.</p>
<p>You can use the roles either directly and adding a password to them or by granting them to a role you are already using.</p>
<p>To use directly:
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">pgstac_read</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;&lt;password&gt;&#39;</span><span class="p">;</span>
</code></pre></div></p>
<p>To grant pgstac permissions to a current postgresql user:
<div class="highlight"><pre><span></span><code><span class="k">GRANT</span><span class="w"> </span><span class="n">pgstac_read</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="o">&lt;</span><span class="k">user</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></p>
<h4 id="pgstac-search-path">PgSTAC Search Path<a class="headerlink" href="#pgstac-search-path" title="Permanent link">&para;</a></h4>
<p>The search_path can be set at the database level or role level or by setting within the current session. The search_path is already set if you are directly using one of the pgstac users. If you are not logging in directly as one of the pgstac users, you will need to set the search_path by adding it to the search_path of the user you are using:
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">user</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">SEARCH_PATH</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">pgstac</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="p">;</span>
</code></pre></div>
setting the search_path on the database:
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">database</span><span class="o">&gt;</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">search_path</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">pgstac</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="p">;</span>
</code></pre></div></p>
<p>In psycopg the search_path can be set by passing it as a configuration when creating your connection:
<div class="highlight"><pre><span></span><code><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="s2">&quot;-c search_path=pgstac,public&quot;</span>
<span class="p">}</span>
</code></pre></div></p>
<h4 id="pgstac-settings-variables">PgSTAC Settings Variables<a class="headerlink" href="#pgstac-settings-variables" title="Permanent link">&para;</a></h4>
<p>There are additional variables that control the settings used for calculating and displaying context (total row count) for a search, as well as a variable to set the filter language (cql-json or cql2-json).
The context is "off" by default, and the default filter language is set to "cql2-json".</p>
<p>Variables can be set either by passing them in via the connection options using your connection library, setting them in the pgstac_settings table or by setting them on the Role that is used to log in to the database.</p>
<p>Turning "context" on can be <strong>very</strong> expensive on larger databases. Much of what PgSTAC does is to optimize the search of items sorted by time where only fewer than 10,000 records are returned at a time. It does this by searching for the data in chunks and is able to "short circuit" and return as soon as it has the number of records requested. Calculating the context (the total count for a query) requires a scan of all records that match the query parameters and can take a very long time. Setting "context" to auto will use database statistics to estimate the number of rows much more quickly, but for some queries, the estimate may be quite a bit off.</p>
<p>Example for updating the pgstac_settings table with a new value:
<div class="highlight"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">pgstac_settings</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;default-filter-lang&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cql-json&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

<span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">pgstac_settings_pkey</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excluded</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></p>
<p>Alternatively, update the role:
<div class="highlight"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">SEARCH_PATH</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">pgstac</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">context</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="o">&lt;</span><span class="s1">&#39;on&#39;</span><span class="p">,</span><span class="s1">&#39;off&#39;</span><span class="p">,</span><span class="s1">&#39;auto&#39;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">context_estimated_count</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;&lt;number of estimated rows when in auto mode that when an estimated count is less than will trigger a full count&gt;&#39;</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">context_estimated_cost</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;&lt;estimated query cost from explain when in auto mode that when an estimated cost is less than will trigger a full count&gt;&#39;</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">context_stats_ttl</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;&lt;an interval string ie &quot;1 day&quot; after which pgstac search will force recalculation of it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">estimates</span><span class="o">&gt;&gt;</span><span class="err">&#39;</span><span class="p">;</span>
</code></pre></div></p>
<p>The check_pgstac_settings function can be used to check what pgstac settings are being used and to check recommendations for system settings. It takes a single parameter which should be the amount of memory available on the database system.
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">check_pgstac_settings</span><span class="p">(</span><span class="s1">&#39;16GB&#39;</span><span class="p">);</span>
</code></pre></div></p>
<h5 id="read-only-mode">Read Only Mode<a class="headerlink" href="#read-only-mode" title="Permanent link">&para;</a></h5>
<p>The pgstac.readonly setting can be used when using pgstac with a read replica.
Note that when pgstac.readonly is set to TRUE that pgstac is unable to use a cache for calculating the total count for context which can make use of the context extension very expensive (see notes above). In readonly mode, pgstac is also unable to register the hash that is used to store queries that can be used with geometry_search (used by titiler-pgstac). A registered hash will still be readable, but new hashes cannot be created on the read only replica, they must be registered on the main database.</p>
<h4 id="runtime-configurations">Runtime Configurations<a class="headerlink" href="#runtime-configurations" title="Permanent link">&para;</a></h4>
<p>Runtime configuration of variables can be made with search by passing in configuration in the search json "conf" item.</p>
<p>Runtime configuration is available for <strong>context</strong>, <strong>context_estimated_count</strong>, <strong>context_estimated_cost</strong>, <strong>context_stats_ttl</strong>, and <strong>nohydrate</strong>.</p>
<p>The nohydrate conf item returns an unhydrated item bypassing the CPU intensive step of rehydrating data with data from the collection metadata. When using the nohydrate conf, the only fields that are respected in the fields extension are geometry and bbox.
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">search</span><span class="p">(</span><span class="s1">&#39;{&quot;conf&quot;:{&quot;nohydrate&quot;=true}}&#39;</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="pgstac-partitioning">PgSTAC Partitioning<a class="headerlink" href="#pgstac-partitioning" title="Permanent link">&para;</a></h4>
<p>By default PgSTAC partitions data by collection (note: this is a change starting with version 0.5.0). Each collection can further be partitioned by either year or month. <strong>Partitioning must be set up prior to loading any data!</strong> Partitioning can be configured by setting the partition_trunc flag on a collection in the database.
<div class="highlight"><pre><span></span><code><span class="k">UPDATE</span><span class="w"> </span><span class="n">collections</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">partition_trunc</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;&lt;collection id&gt;&#39;</span><span class="p">;</span>
</code></pre></div></p>
<p>In general, you should aim to keep each partition less than a few hundred thousand rows. Further partitioning (ie setting everything to 'month' when not needed to keep the partitions below a few hundred thousand rows) can be detrimental.</p>
<h4 id="pgstac-indexes-queryables">PgSTAC Indexes / Queryables<a class="headerlink" href="#pgstac-indexes-queryables" title="Permanent link">&para;</a></h4>
<p>By default, PgSTAC includes indexes on the id, datetime, collection, and geometry. Further indexing can be added for additional properties globally or only on particular collections by modifications to the queryables table.</p>
<p>The <code>queryables</code> table controls the indexes that PgSTAC will build as well as the metadata that is returned from a <a href="https://github.com/stac-api-extensions/filter#queryables">STAC Queryables endpoint</a>.</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Description</th>
<th>Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>The id of the queryable</td>
<td>bigint[pk]</td>
<td>-</td>
</tr>
<tr>
<td><code>name</code></td>
<td>The name of the property</td>
<td>text</td>
<td><code>eo:cloud_cover</code></td>
</tr>
<tr>
<td><code>collection_ids</code></td>
<td>The collection ids that this queryable applies to</td>
<td>text[]</td>
<td><code>{sentinel-2-l2a,landsat-c2-l2,aster-l1t}</code> or <code>NULL</code></td>
</tr>
<tr>
<td><code>definition</code></td>
<td>The queryable definition of the property</td>
<td>jsonb</td>
<td><code>{"title": "Cloud Cover", "type": "number", "minimum": 0, "maximum": 100}</code></td>
</tr>
<tr>
<td><code>property_wrapper</code></td>
<td>The wrapper function to use to convert the property to a searchable type</td>
<td>text</td>
<td>One of <code>to_int</code>, <code>to_float</code>, <code>to_tstz</code>, <code>to_text</code> or <code>NULL</code></td>
</tr>
<tr>
<td><code>property_index_type</code></td>
<td>The index type to use for the property</td>
<td>text</td>
<td><code>BTREE</code>, <code>NULL</code> or other valid <a href="https://www.postgresql.org/docs/current/indexes-types.html">PostgreSQL index type</a></td>
</tr>
</tbody>
</table>
<p>Each record in the queryables table references a single property but can apply to any number of collections. If the <code>collection_ids</code> field is left as NULL, then that queryable will apply to all collections. There are constraints that allow only a single queryable record to be active per collection. If there is a queryable already set for a property field with collection_ids set to NULL, you will not be able to create a separate queryable entry that applies to that property with a specific collection as pgstac would not then be able to determine which queryable entry to use.</p>
<p>By default, any property may be used in filter expressions. If you wish to restrict it and only allow the queryables, you should either set the additional_properties setting variable to False or make the corresponding adjustment in the pgstac_settings table.</p>
<h5 id="queryable-metadata">Queryable Metadata<a class="headerlink" href="#queryable-metadata" title="Permanent link">&para;</a></h5>
<p>When used with <a href="https://stac-utils.github.io/stac-fastapi/">stac-fastapi</a>, the metadata returned in the queryables endpoint is determined using the definition field on the <code>queryables</code> table. This is a jsonb field that will be returned as-is in the queryables response. The full queryable response for a collection will be determined by all the <code>queryables</code> records that have a match in <code>collection_ids</code> or have a NULL <code>collection_ids</code>.</p>
<p>If two or more collections in your catalog share a property name, but have different definitions (e.g., <code>platform</code> with different enum values), be sure to repeat the property for each collection id, each with a unique <code>definition</code>.</p>
<p>There is a utility SQL function that can be used to help populate the <code>queryables</code> table by looking at a sample of data for each collection. This utility can also look to the json schema for STAC extensions defined in the <code>stac_extensions</code> table.</p>
<p>The <code>stac_extensions</code> table contains a <code>url</code> field and a <code>content</code> field for each extension that should be introspected to compare for fields. This can either be filled in manually or by using the <code>pypgstac loadextensions</code> command included with pypgstac. This command will look at the <code>stac_extensions</code> attribute in all collections to populate the <code>stac_extensions</code> table, fetching the json content of each extension. If any urls were added manually to the stac_extensions table, it will also populate any records where the content is NULL.</p>
<p>Once the <code>stac_extensions</code> table has been filled in, you can run the <code>missing_queryables</code> function either for a single collection:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">missing_queryables</span><span class="p">(</span><span class="s1">&#39;mycollection&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>or for all collections:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">missing_queryables</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>The numeric argument is the approximate percent of items that should be sampled to look for fields to include. This function will look for fields in the properties of items that do not already exist in the queryables table for each collection. It will then look to see if there is a field in any definition in the stac_extensions table to populate the definition for the queryable. If no definition was found, it will use the data type of the values for that field in the sample of items to fill in a generic definition with just the field type.</p>
<p>In order to populate the queryables table, you can then run the following query. Note we're casting the collection id to a text array:</p>
<div class="highlight"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">queryables</span><span class="w"> </span><span class="p">(</span><span class="n">collection_ids</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">definition</span><span class="p">,</span><span class="w"> </span><span class="n">property_wrapper</span><span class="p">)</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="nb">array</span><span class="p">[</span><span class="n">collection</span><span class="p">]::</span><span class="nb">text</span><span class="p">[]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">collection_ids</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">definition</span><span class="p">,</span><span class="w"> </span><span class="n">property_wrapper</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">missing_queryables</span><span class="p">(</span><span class="s1">&#39;mycollection&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<p>If you run into conflicts due to the unique constraints on collection/name, you may need to create a temp table, make any changes to remove the conflicts, and then INSERT.</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">draft_queryables</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">missing_queryables</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>Make any edits to that table or the existing queryables, then:</p>
<div class="highlight"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">queryables</span><span class="w"> </span><span class="p">(</span><span class="n">collection_ids</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">definition</span><span class="p">,</span><span class="w"> </span><span class="n">property_wrapper</span><span class="p">)</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">draft_queryables</span><span class="p">;</span>
</code></pre></div>
<h5 id="indexing">Indexing<a class="headerlink" href="#indexing" title="Permanent link">&para;</a></h5>
<p>The <code>queryables</code> table is also used to specify which item <code>properties</code> attributes to add indexes on.</p>
<p>To add a new global index across all collection partitions:</p>
<div class="highlight"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">queryables</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">property_wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">property_index_type</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">property</span><span class="w"> </span><span class="n">name</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">property</span><span class="w"> </span><span class="n">wrapper</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="k">index</span><span class="w"> </span><span class="k">type</span><span class="o">&gt;</span><span class="p">);</span>
</code></pre></div>
<p>Property wrapper should be one of <code>to_int</code>, <code>to_float</code>, <code>to_tstz</code>, or <code>to_text</code>. The index type should almost always be <code>BTREE</code>, but can be any PostgreSQL index type valid for the data type.</p>
<p><strong>More indexes is not necessarily better.</strong> You should only index the primary fields that are actively being used to search. Adding too many indexes can be very detrimental to performance and ingest speed. If your primary use case is delivering items sorted by datetime and you do not use the context extension, you likely will not need any further indexes.</p>
<p>Leave <code>property_index_type</code> set to NULL if you do not want an index set for a property.</p>
<h3 id="maintenance-procedures">Maintenance Procedures<a class="headerlink" href="#maintenance-procedures" title="Permanent link">&para;</a></h3>
<p>These are procedures that should be run periodically to make sure that statistics and constraints are kept up-to-date and validated. These can be made to run regularly using the pg_cron extension if available.
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">cron</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="s1">&#39;0 * * * *&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CALL validate_constraints();&#39;</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">cron</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="s1">&#39;10, * * * *&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CALL analyze_items();&#39;</span><span class="p">);</span>
</code></pre></div></p>
<h3 id="system-checks">System Checks<a class="headerlink" href="#system-checks" title="Permanent link">&para;</a></h3>
<h4 id="system-and-pgstac-settings">System and pgSTAC Settings<a class="headerlink" href="#system-and-pgstac-settings" title="Permanent link">&para;</a></h4>
<p>PgSTAC includes a function for checking common Postgres settings. You must pass in the amount of total memory available to get appropriate memory settings. Do note that these suggestions are merely a good first pass and figuring out the ideal parameters requires further analysis of a system and logs.
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">check_pgstac_settings</span><span class="p">(</span><span class="s1">&#39;32GB&#39;</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="unused-indexes">Unused Indexes<a class="headerlink" href="#unused-indexes" title="Permanent link">&para;</a></h4>
<p>Having too many indexes that do not get used can drastically hurt the performance of the database. The following query can be used to show indexes that are not getting used and should be considered for removal.
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">    </span><span class="n">relname</span><span class="p">,</span><span class="w"> </span><span class="n">indexrelname</span><span class="p">,</span><span class="w"> </span><span class="n">idx_scan</span><span class="p">,</span><span class="w"> </span><span class="n">last_idx_scan</span><span class="p">,</span><span class="n">idx_tup_read</span><span class="p">,</span><span class="w"> </span><span class="n">idx_tup_fetch</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">relid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">index_bytes</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">relid</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">index_size</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_user_indexes</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pgstac&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="k">ASC</span>
<span class="p">;</span>
</code></pre></div></p>
<h3 id="notification-triggers">Notification Triggers<a class="headerlink" href="#notification-triggers" title="Permanent link">&para;</a></h3>
<p>You can add notification triggers alongside pgstac to get notified when items are inserted, updated, or deleted.</p>
<p><strong>Important:</strong> Do NOT create these in the <code>pgstac</code> schema as they could be removed in future migrations.</p>
<p><strong>Note on pgSTAC's UPDATE behavior:</strong> For performance and consistency, <code>update_item()</code> in pgSTAC uses a <strong>DELETE+INSERT</strong> pattern instead of a direct SQL <code>UPDATE</code>. As a result, standard <code>UPDATE</code> triggers will not fire during these operations. Applications that rely on change notifications should implement logic that accounts for this behavior.</p>
<h4 id="example-notification-setup">Example Notification Setup<a class="headerlink" href="#example-notification-setup" title="Permanent link">&para;</a></h4>
<p>Here's an example of how to set up notification triggers for item changes:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create the notification function</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">notify_items_change_func</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">DECLARE</span>

<span class="k">BEGIN</span>
<span class="w">    </span><span class="n">PERFORM</span><span class="w"> </span><span class="n">pg_notify</span><span class="p">(</span><span class="s1">&#39;pgstac_items_change&#39;</span><span class="p">::</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="n">json_build_object</span><span class="p">(</span>
<span class="w">            </span><span class="s1">&#39;operation&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">TG_OP</span><span class="p">,</span>
<span class="w">            </span><span class="s1">&#39;items&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">jsonb_agg</span><span class="p">(</span>
<span class="w">                </span><span class="n">jsonb_build_object</span><span class="p">(</span>
<span class="w">                    </span><span class="s1">&#39;collection&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">collection</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">id</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">)::</span><span class="nb">text</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Create triggers for INSERT operations</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">notify_items_change_insert</span>
<span class="w">    </span><span class="k">AFTER</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">items</span>
<span class="w">    </span><span class="k">REFERENCING</span><span class="w"> </span><span class="k">NEW</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">STATEMENT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">notify_items_change_func</span><span class="p">()</span>
<span class="p">;</span>

<span class="c1">-- Create triggers for UPDATE operations</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">notify_items_change_update</span>
<span class="w">    </span><span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">items</span>
<span class="w">    </span><span class="k">REFERENCING</span><span class="w"> </span><span class="k">NEW</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">STATEMENT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">notify_items_change_func</span><span class="p">()</span>
<span class="p">;</span>

<span class="c1">-- Create triggers for DELETE operations</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">notify_items_change_delete</span>
<span class="w">    </span><span class="k">AFTER</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">pgstac</span><span class="p">.</span><span class="n">items</span>
<span class="w">    </span><span class="k">REFERENCING</span><span class="w"> </span><span class="k">OLD</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">STATEMENT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">notify_items_change_func</span><span class="p">()</span>
<span class="p">;</span>
</code></pre></div>
<h4 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h4>
<p>Listen for notifications:
<div class="highlight"><pre><span></span><code><span class="k">LISTEN</span><span class="w"> </span><span class="n">pgstac_items_change</span><span class="p">;</span>
</code></pre></div></p>
<p>Payload structure:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;operation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INSERT&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;items&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;collection&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sentinel-2-l2a&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;item-1&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;collection&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sentinel-2-l2a&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;item-2&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="customization">Customization<a class="headerlink" href="#customization" title="Permanent link">&para;</a></h4>
<p>You may modify the function to include additional metadata, filter by collection, or use different channels. Only trigger on the <code>items</code> table, not <code>items_staging</code>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/stac-utils" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/STACspec" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>